# Story 6.1: Automated Certificate Expiry Reminders

## Status

Ready for Dev

## Story

**As a builder**, I want to receive an automated email notification about expiring worker certifications so that I can proactively manage compliance and avoid on‑site issues.

## Acceptance Criteria

1. A Supabase Edge Function is scheduled (daily) to find certifications expiring in the next 30 days.
2. The function identifies unique workers with upcoming expiries and prepares builder and per‑worker summaries.
3. A webhook is triggered to Make.com or n8n with a payload for:
   - Builder summary email listing all expiries (name, email, expiry date)
   - Individual worker emails with link to induction form to upload a new card
4. The workflow prevents duplicate notifications (same worker, same expiry date) within a rolling window (e.g., 7 days).
5. Errors are logged; failures are retried with backoff; metrics available via simple audit table.
6. Secrets and API keys are not exposed publicly; function uses environment variables only.

## Tasks / Subtasks

- [ ] Edge Function `expiry-reminders` (AC: 1–6)
  - [ ] Path: `supabase/functions/expiry-reminders/index.ts`
  - [ ] Query certifications expiring between `today` and `today + 30d`; join workers
  - [ ] Build payloads for builder and workers
  - [ ] Check de‑duplication table before sending (7‑day cooldown per worker/expiry)
  - [ ] POST to automation webhook(s): `MAKE_WEBHOOK_URL` and/or `N8N_WEBHOOK_URL`
  - [ ] Record audit rows: success/failure, counts, duration
- [ ] Scheduling (AC: 1)
  - [ ] Configure Supabase scheduled task (cron) or external scheduler to call function daily
- [ ] Data model & policies (AC: 4–5)
  - [ ] Migration: `notification_audits` and `notification_dedup` tables with RLS
  - [ ] RLS: builder/admin read; service role insert
- [ ] Environment (AC: 6)
  - [ ] Env vars: `AUTOMATION_PROVIDER`, `MAKE_WEBHOOK_URL`, `N8N_WEBHOOK_URL`, `INDUCTION_URL`
- [ ] Type safety & lint
  - [ ] Types for request/response/audit rows; strict TS; ESLint pass

## Dev Notes

### Relevant Architecture References

- PRD Epic 6 Story 6.1. [Source: `docs/prd/epic-6-automation-notifications.md#story-6.1-automated-certificate-expiry-reminders`]
- Security & RLS; Edge Functions. [Source: `docs/architecture.md`]
- Data models (workers, certifications). [Source: `docs/architecture/data-models.md`]

### Implementation Outline

- Compute `today` and `in30` in UTC; consider Australian timezone display when formatting emails.
- Query latest certification per worker; filter where `expiry_date` in [today, in30].
- Build two payloads: builder summary and an array for worker notifications. Include `INDUCTION_URL` for CTA.
- De‑dup: a `notification_dedup` row keyed by `worker_id + expiry_date + type='expiry'`; if exists within 7 days, skip.
- Send to `MAKE_WEBHOOK_URL` or `N8N_WEBHOOK_URL` based on `AUTOMATION_PROVIDER`.
- Write `notification_audits` with counts, duration, and result; log errors for observability.

### Example Snippets

```ts
// supabase/functions/expiry-reminders/index.ts
import 'jsr:@supabase/functions-js/edge-runtime.d.ts'

interface WorkerExpiry { worker_id: string; full_name: string; email: string; expiry_date: string }

Deno.serve(async () => {
  const started = Date.now()
  try {
    const today = new Date().toISOString().slice(0,10)
    const in30 = new Date(Date.now() + 30*24*60*60*1000).toISOString().slice(0,10)

    // TODO: query latest certification per worker expiring between today and in30
    const expiries: WorkerExpiry[] = []

    // TODO: filter using dedup table

    const builderPayload = {
      type: 'builder_summary',
      generated_at: new Date().toISOString(),
      expiries: expiries.map(e => ({ name: e.full_name, email: e.email, expiry_date: e.expiry_date }))
    }
    const workerPayloads = expiries.map((e) => ({
      type: 'worker_notice',
      worker_id: e.worker_id,
      name: e.full_name,
      email: e.email,
      expiry_date: e.expiry_date,
      induction_url: Deno.env.get('INDUCTION_URL')
    }))

    const provider = Deno.env.get('AUTOMATION_PROVIDER') || 'make'
    const url = provider === 'n8n' ? Deno.env.get('N8N_WEBHOOK_URL') : Deno.env.get('MAKE_WEBHOOK_URL')
    if (!url) throw new Error('Webhook URL not configured')

    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ builder: builderPayload, workers: workerPayloads }) })
    if (!res.ok) throw new Error('Automation webhook failed')

    // TODO: write dedup rows and audit success
    return new Response(JSON.stringify({ ok: true, count: expiries.length }), { headers: { 'Content-Type': 'application/json' } })
  } catch (e) {
    // TODO: audit failure
    return new Response(JSON.stringify({ ok: false, error: String(e) }), { status: 500, headers: { 'Content-Type': 'application/json' } })
  } finally {
    const duration = Date.now() - started
    console.log('expiry-reminders duration', duration)
  }
})
```

```sql
-- Migration: notifications audit and dedup
create table if not exists notification_audits (
  id bigserial primary key,
  kind text not null,
  payload jsonb,
  result text not null,
  created_at timestamptz not null default now()
);

create table if not exists notification_dedup (
  id bigserial primary key,
  worker_id uuid not null,
  expiry_date date not null,
  type text not null default 'expiry',
  created_at timestamptz not null default now(),
  unique(worker_id, expiry_date, type)
);

alter table notification_audits enable row level security;
alter table notification_dedup enable row level security;
create policy "builder can read audits" on notification_audits for select using (true);
create policy "service role inserts audits" on notification_audits for insert with check (true);
create policy "builder can read dedup" on notification_dedup for select using (true);
create policy "service role inserts dedup" on notification_dedup for insert with check (true);
```

## Testing Requirements

- Function run produces correct builder summary list and individual worker notifications for expiries within 30 days
- Deduplication prevents repeat notifications within 7 days for same worker/expiry
- Audit rows persist success and failure cases; webhook errors are handled with retries/backoff (manually test retry logic)
- TypeScript/ESLint pass; no secrets leaked; environment variables required are documented and checked

## Technical Constraints

- Supabase Edge Function with scheduled invocation (cron)
- Use parameterised queries or RPC/views for latest‑cert efficiently
- Australian English in content; handle timezones appropriately for dates in emails

## Assumptions

- Builder email address and worker emails are present and valid in database
- Automation platform is reachable from Edge Function; webhook secured via shared secret (optional)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-15 | 0.1 | Initial draft for Epic 6 Story 6.1 with Edge Function, dedup, and automation webhook. | SM |
| 2025-08-17 | 0.2 | Status updated to Ready for Dev after standards review (App Router, TS strict, Tailwind, accessibility, SEO, loading/error). | SM |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
