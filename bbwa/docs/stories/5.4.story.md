# Story 5.4: Worker and Compliance Management

## Status

Ready for Dev

## Story

**As a builder**, I want to view and manage worker compliance data so that I can ensure all on‑site personnel have valid certifications.

## Acceptance Criteria

1. An admin page lists all inducted workers with columns: Name, Email, Company, White Card Status (Valid | Expired | Awaiting Review), Expiry Date.
2. Clicking a worker opens a details view showing uploaded certifications and history.
3. The builder can manually update a worker's certification status and expiry date from the details page.
4. All actions require authentication; enforce authorisation (builder role) and RLS.
5. The UI is responsive, accessible (WCAG 2.2), and includes loading and error states.

## Tasks / Subtasks

- [ ] Routing & scaffolding (AC: 1–5)
  - [ ] List page (Server): `apps/web/src/app/admin/workers/page.tsx`
  - [ ] Detail page (Server + Client form for editing): `apps/web/src/app/admin/workers/[id]/page.tsx`
  - [ ] Loading/Error UIs for both routes
  - [ ] Metadata: titles `Workers — Admin` and `Worker — Admin`
  - [ ] Server guard: redirect unauthenticated/unauthorised to login
- [ ] Data queries (AC: 1–2, 4)
  - [ ] List workers with latest certification summary via a view/RPC to avoid N+1
  - [ ] Detail query returns worker, latest certification, and related uploads from Storage
  - [ ] Provide signed URLs for private assets if needed; otherwise public read bucket
- [ ] Edit operations (AC: 3, 4)
  - [ ] Client form in details page to update `status` and `expiry_date`
  - [ ] Server action `updateCertification(workerId, { status, expiryDate })` with validation and RLS checks
  - [ ] Optionally allow uploading replacement white card; triggers status `Awaiting Review`
  - [ ] Revalidate admin and public pages impacted by status changes
- [ ] Type safety & lint (AC: 5)
  - [ ] Types in `apps/web/src/types/workers.ts`
  - [ ] `npx tsc --noEmit`; `npm run lint -w apps/web`

## Dev Notes

### Relevant Architecture References

- PRD Epic 5 Story 5.4. [Source: `docs/prd/epic-5-admin-dashboard-content-management.md#story-5.4-worker-and-compliance-management`]
- Security & RLS; Server Components. [Source: `docs/architecture.md`]
- Data models (workers, certifications, certification uploads). [Source: `docs/architecture/data-models.md`]

### Implementation Outline

- List Page:
  - Use a view/RPC `worker_cert_summary` to fetch each worker's latest certification status and expiry date efficiently.
  - Show a compact table; clicking name navigates to details.
- Details Page:
  - Display personal details, current status, expiry date, and a gallery of uploaded documents.
  - Include an edit form (Client) with status dropdown and date input; submit via server action.
  - When status moves to `Valid`, ensure expiry is in the future; when `Expired`, require an expiry date or auto‑set to past.
- Storage:
  - If downloads require auth, generate signed URLs in Server Component and pass to Client for rendering.
- Accessibility & UX:
  - Announce updates via `aria-live`; focus first error; clear labels.
  - Mobile‑first with Tailwind; keep tables scrollable horizontally on small screens.

### Example Snippets

```tsx
// apps/web/src/app/admin/workers/page.tsx (list)
import Link from 'next/link'
import { createClient } from '@/src/lib/supabase/server'

export const metadata = { title: 'Workers — Admin' }

export default async function AdminWorkersPage() {
  const supabase = createClient()
  const { data } = await supabase
    .from('worker_cert_summary')
    .select('worker_id, full_name, email, company, status, expiry_date')
    .order('full_name')

  return (
    <main className="mx-auto max-w-5xl px-4 py-6">
      <h1 className="text-2xl font-semibold">Workers</h1>
      <div className="mt-4 overflow-x-auto">
        <table className="min-w-full text-left">
          <thead className="text-sm text-gray-600">
            <tr>
              <th className="py-2 pr-4">Name</th>
              <th className="py-2 pr-4">Email</th>
              <th className="py-2 pr-4">Company</th>
              <th className="py-2 pr-4">White Card</th>
              <th className="py-2 pr-4">Expiry</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {(data || []).map((w) => (
              <tr key={w.worker_id}>
                <td className="py-2 pr-4"><Link className="underline" href={`/admin/workers/${w.worker_id}`}>{w.full_name}</Link></td>
                <td className="py-2 pr-4">{w.email}</td>
                <td className="py-2 pr-4">{w.company || '—'}</td>
                <td className="py-2 pr-4">{w.status || 'Awaiting Review'}</td>
                <td className="py-2 pr-4">{w.expiry_date ? new Date(w.expiry_date).toLocaleDateString() : '—'}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </main>
  )
}
```

```tsx
// apps/web/src/app/admin/workers/[id]/page.tsx (detail + edit)
import { createClient } from '@/src/lib/supabase/server'
import { UpdateComplianceForm } from './update-form'

export const metadata = { title: 'Worker — Admin' }

export default async function WorkerDetailPage({ params }: { params: { id: string } }) {
  const supabase = createClient()
  const { data: worker } = await supabase.from('workers').select('*').eq('id', params.id).maybeSingle()
  const { data: cert } = await supabase.from('certifications').select('*').eq('worker_id', params.id).order('updated_at', { ascending: false }).maybeSingle()
  const { data: uploads } = await supabase.from('storage_items').select('*').eq('worker_id', params.id).order('created_at', { ascending: false })

  return (
    <main className="mx-auto max-w-3xl px-4 py-6 space-y-6">
      <header>
        <h1 className="text-2xl font-semibold">{worker?.full_name}</h1>
        <p className="text-gray-700">{worker?.email}</p>
      </header>
      <section className="space-y-2">
        <p>Status: <strong>{cert?.status || 'Awaiting Review'}</strong></p>
        <p>Expiry: <strong>{cert?.expiry_date ? new Date(cert.expiry_date).toLocaleDateString() : '—'}</strong></p>
      </section>
      <section>
        <UpdateComplianceForm initial={{ workerId: worker?.id, status: cert?.status, expiryDate: cert?.expiry_date }} />
      </section>
      <section>
        <h2 className="text-xl font-semibold">Certifications</h2>
        <ul className="mt-2 grid grid-cols-2 gap-3">
          {(uploads || []).map((u) => (
            <li key={u.id}><a className="underline" href={u.public_url} target="_blank">{u.label || u.path}</a></li>
          ))}
        </ul>
      </section>
    </main>
  )
}
```

```tsx
// apps/web/src/app/admin/workers/[id]/update-form.tsx (client sketch)
'use client'
import { useRef, useState } from 'react'
import { updateCertification } from './actions'

export function UpdateComplianceForm({ initial }: { initial: { workerId: string; status?: string; expiryDate?: string } }) {
  const [errors, setErrors] = useState<Record<string, string>>({})
  const [status, setStatus] = useState<'idle'|'saving'>('idle')
  const errorRef = useRef<HTMLDivElement | null>(null)

  async function onSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault()
    setErrors({}); setStatus('saving')
    const form = new FormData(e.currentTarget)
    const res = await updateCertification(form)
    setStatus('idle')
    if (res?.errors) return setErrors(res.errors)
  }

  return (
    <form onSubmit={onSubmit} className="space-y-3">
      {Object.keys(errors).length > 0 && (
        <div ref={errorRef} tabIndex={-1} role="alert" className="rounded border border-red-300 bg-red-50 p-3 text-red-700">Please correct the highlighted fields below.</div>
      )}
      <input type="hidden" name="workerId" defaultValue={initial.workerId} />
      <label className="block">
        <span className="sr-only">Status</span>
        <select name="status" defaultValue={initial.status || 'Awaiting Review'} className="w-full border p-2">
          <option>Awaiting Review</option>
          <option>Valid</option>
          <option>Expired</option>
        </select>
      </label>
      <label className="block">
        <span className="sr-only">Expiry Date</span>
        <input type="date" name="expiryDate" defaultValue={initial.expiryDate || ''} className="w-full border p-2" />
      </label>
      <button disabled={status==='saving'} className="bg-black px-4 py-2 text-white">{status==='saving' ? 'Saving…' : 'Save changes'}</button>
    </form>
  )
}
```

```ts
// apps/web/src/app/admin/workers/[id]/actions.ts (sketch)
'use server'
import { createClient } from '@/src/lib/supabase/server'
import { revalidatePath } from 'next/cache'

export async function updateCertification(form: FormData) {
  const supabase = createClient()
  const workerId = String(form.get('workerId') || '')
  const status = String(form.get('status') || '')
  const expiryDate = String(form.get('expiryDate') || '')

  if (!workerId) return { errors: { form: 'Invalid worker.' } }
  if (!status) return { errors: { status: 'Status is required' } }
  if (status === 'Valid' && expiryDate && expiryDate < new Date().toISOString().slice(0,10)) {
    return { errors: { expiryDate: 'Expiry must be today or later for Valid' } }
  }

  const { error } = await supabase.from('certifications').insert({ worker_id: workerId, status, expiry_date: expiryDate || null })
  if (error) return { errors: { form: 'Unable to update at this time.' } }

  revalidatePath('/admin/workers')
  revalidatePath(`/admin/workers/${workerId}`)
  return { success: true }
}
```

```sql
-- View/RPC sketch for list summary (improve in proper migration)
-- worker_cert_summary: one row per worker with latest certification
-- Columns: worker_id, full_name, email, company, status, expiry_date
```

## Testing Requirements

- List page shows all workers with correct status/expiry (including edge cases: none uploaded → Awaiting Review)
- Detail page displays current data and assets; updating status/expiry writes a new certification row and revalidates pages
- RLS prevents non‑builder access; admin/builder can view/edit
- Accessibility checks (axe) pass; mobile‑first layout verified
- TypeScript strict and ESLint pass

## Technical Constraints

- Next.js App Router; Server Components by default; Client only for the edit form
- Supabase with RLS; prefer views/RPC to avoid N+1 queries; signed URLs for private storage
- Tailwind CSS; Australian English spelling; Netlify deploy with environment variables set

## Assumptions

- `certifications` table supports multiple versions per worker (append‑only); latest row determines status
- Storage records (e.g., `storage_items`) reference worker uploads and can be listed for the detail page

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-15 | 0.1 | Initial draft for Epic 5 Story 5.4 with list, details, edit action, and RLS. | SM |
| 2025-08-17 | 0.2 | Status updated to Ready for Dev after standards review (App Router, TS strict, Tailwind, accessibility, SEO, loading/error). | SM |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
