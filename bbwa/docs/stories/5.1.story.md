# Story 5.1: Admin Dashboard Homepage

## Status

Ready for Dev

## Story

**As a builder**, I want to see an at‑a‑glance overview of key information when I log in so that I can quickly check on project statuses and compliance.

## Acceptance Criteria

1. After successful login, navigating to `/admin` shows the dashboard homepage.
2. The page displays key metrics:
   - Active workers count (currently inducted and valid white cards).
   - Recent site check‑ins (site name, worker, time) for last 24 hours.
   - Upcoming certification expirations within the next 30 days.
3. The UI is simple, clean, responsive (mobile and tablet friendly), and accessible (WCAG 2.2).
4. Loading states (skeletons) and error boundaries exist for the dashboard route.
5. Server Components by default; no sensitive data is exposed to Client Components.
6. Supabase RLS remains enforced; queries use service‑safe patterns via server actions or server components.

## Tasks / Subtasks

- [ ] Routing & scaffolding (AC: 1, 3–5)
  - [ ] Directory: `apps/web/src/app/admin/`
  - [ ] Page (Server Component): `apps/web/src/app/admin/page.tsx`
  - [ ] Loading UI: `apps/web/src/app/admin/loading.tsx`
  - [ ] Error UI: `apps/web/src/app/admin/error.tsx`
  - [ ] Metadata: title `Admin Dashboard`
  - [ ] Protect route (server‑side): redirect unauthenticated users to login
- [ ] Data fetching (AC: 2, 6)
  - [ ] Use `createClient()` on server to query:
    - [ ] Active workers: workers with latest certification not expired
    - [ ] Recent check‑ins: last 24h from `site_attendances` joined with sites and workers (limited to 10)
    - [ ] Upcoming expirations: certifications expiring in next 30 days
- [ ] UI components (AC: 2–3)
  - [ ] `apps/web/src/app/admin/_components/Kpi.tsx` (Server) simple KPI card
  - [ ] `apps/web/src/app/admin/_components/RecentCheckins.tsx` (Server) list
  - [ ] `apps/web/src/app/admin/_components/UpcomingExpirations.tsx` (Server) list
  - [ ] Tailwind for layout; mobile‑first; semantic headings; aria labels
- [ ] Type safety & lint
  - [ ] Shared types in `apps/web/src/types/dashboard.ts`
  - [ ] `npx tsc --noEmit` and `npm run lint -w apps/web`

## Dev Notes

### Relevant Architecture References

- PRD Epic 5 Story 5.1. [Source: `docs/prd/epic-5-admin-dashboard-content-management.md#story-5.1-admin-dashboard-homepage`]
- Security & RLS; Server Components. [Source: `docs/architecture.md`]
- Data models (workers, certifications, site_attendances, job_sites, projects). [Source: `docs/architecture/data-models.md`]

### Implementation Outline

- Auth guard in `page.tsx` using a server helper (e.g., Supabase auth session) to redirect if unauthenticated.
- Queries (examples):
  - Active workers: latest certification per worker not expired (today or future).
  - Recent check‑ins: `site_attendances` joined to workers and job_sites ordered desc limit 10 within 24h.
  - Upcoming expirations: certifications where expiry_date between today and today + 30 days.
- Render three KPI/summary blocks with concise data and links to details pages (to be defined in later stories).
- Accessibility: headings order, focus states, sufficient contrast; skeletons for loading.

### Example Snippets

```tsx
// apps/web/src/app/admin/page.tsx
import { createClient } from '@/src/lib/supabase/server'

export const metadata = { title: 'Admin Dashboard' }

export default async function AdminDashboardPage() {
  const supabase = createClient()

  // Auth guard (pseudo; replace with real session retrieval)
  const {
    data: { user },
  } = await supabase.auth.getUser()
  if (!user) {
    // Prefer server redirect helper
    return null
  }

  const today = new Date().toISOString().slice(0, 10)
  const in30 = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10)

  // Active workers (simplified; adjust with proper SQL/view for latest cert)
  const { data: activeWorkersCount } = await supabase
    .rpc('active_workers_count', { p_today: today }) // Prefer a prepared RPC/view

  const { data: recent } = await supabase
    .from('site_attendances')
    .select('created_at, job_sites(name), workers(full_name)')
    .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString())
    .order('created_at', { ascending: false })
    .limit(10)

  const { data: upcoming } = await supabase
    .from('certifications')
    .select('worker_id, expiry_date, workers(full_name)')
    .gte('expiry_date', today)
    .lte('expiry_date', in30)
    .order('expiry_date')

  return (
    <main className="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 py-6 space-y-8">
      <h1 className="text-2xl font-semibold">Dashboard</h1>
      <section className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <Kpi title="Active Workers" value={activeWorkersCount ?? 0} />
        <Kpi title="Recent Check‑ins (24h)" value={recent?.length ?? 0} />
        <Kpi title="Expiring (30d)" value={upcoming?.length ?? 0} />
      </section>
      <section className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <RecentCheckins items={recent || []} />
        <UpcomingExpirations items={upcoming || []} />
      </section>
    </main>
  )
}
```

```tsx
// apps/web/src/app/admin/_components/Kpi.tsx
export default function Kpi({ title, value }: { title: string; value: number }) {
  return (
    <div className="rounded border p-4">
      <p className="text-sm text-gray-600">{title}</p>
      <p className="mt-2 text-3xl font-semibold">{value}</p>
    </div>
  )
}
```

```tsx
// apps/web/src/app/admin/loading.tsx
export default function Loading() {
  return (
    <main className="mx-auto max-w-5xl px-4 py-6">
      <div className="animate-pulse grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {[...Array(3)].map((_, i) => (
          <div key={i} className="h-20 rounded bg-gray-100" />
        ))}
      </div>
    </main>
  )
}
```

## Testing Requirements

- Auth: unauthenticated users are redirected to login; authenticated users see dashboard.
- Data: counts and lists reflect database state; edge cases: zero workers, zero check‑ins, zero expirations.
- Performance: queries efficient; avoid N+1 issues; use indexes or views/RPC where appropriate.
- Accessibility: headings order, focus states, contrast; mobile responsiveness validated.
- Static checks: TypeScript strict and ESLint pass.

## Technical Constraints

- Next.js App Router; Server Components by default.
- Supabase with RLS; prefer views/RPC for complex aggregations; no secrets in client.
- Tailwind CSS for styling; Australian English spelling.
- Deployed with Netlify; environment variables configured per environment.

## Assumptions

- RPC `active_workers_count(p_today date)` or a materialized view will be added in a migration.
- Tables exist: `workers`, `certifications`, `site_attendances`, `job_sites` with appropriate RLS.
- Auth already set up and session retrievable on the server.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-15 | 0.1 | Initial draft for Epic 5 Story 5.1 with KPIs, recent check‑ins, and upcoming expirations. | SM |
| 2025-08-17 | 0.2 | Status updated to Ready for Dev after standards review (App Router, TS strict, Tailwind, accessibility, SEO, loading/error). | SM |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
