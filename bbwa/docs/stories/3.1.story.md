# Story 3.1: Worker Induction Form (Personal Details)

## Status

Ready for Dev

## Story

**As a worker or visitor**, I want to fill out my personal details so that I can begin the on-site induction process.

## Acceptance Criteria

1. A multi-step form is started and this step collects personal details: Full Name, Email, Company, Trade, Contact Number.
2. Client-side validation prevents proceeding with missing/invalid required fields.
3. Server-side validation re-validates input and sanitises values.
4. Data is held in a temporary session (cookie-based) until final submission in later steps.
5. Mobile-first layout and accessible labels, help text, and errors.
6. CSRF protection and basic spam prevention in place.
7. Loading and error UI present.

## Tasks / Subtasks

- [ ] Route and scaffolding (AC: 1, 5, 7)
  - [ ] Directory: `apps/web/src/app/induction/`
  - [ ] Step 1 page: `apps/web/src/app/induction/step-1/page.tsx` (Server Component rendering Client form)
  - [ ] Loading UI: `apps/web/src/app/induction/step-1/loading.tsx`
  - [ ] Error UI: `apps/web/src/app/induction/step-1/error.tsx`
  - [ ] Progress indicator component: `apps/web/src/app/induction/Progress.tsx` (Server Component)
- [ ] Client form component (AC: 1–3, 5–6)
  - [ ] File: `apps/web/src/app/induction/step-1/PersonalDetailsForm.tsx` (Client)
  - [ ] Fields: fullName (required), email (required RFC), company (optional), trade (required), phone (required, E.164 or AU pattern)
  - [ ] Inline, per-field errors; focus first error on submit
  - [ ] CSRF hidden input; basic honeypot `website` field
- [ ] Server actions and session (AC: 2–4, 6)
  - [ ] File: `apps/web/src/app/induction/step-1/actions.ts`
  - [ ] Action `issueCsrfToken()` to set cookie; `saveStep1()` to validate + write JSON to a signed, httpOnly cookie (e.g., `induction_session`)
  - [ ] Use `crypto` for CSRF token; consider encryption/signing of session payload
  - [ ] On success, redirect to `/induction/step-2`
- [ ] Accessibility & UX (AC: 5)
  - [ ] Labels associated; aria-live for form status; visible focus rings
  - [ ] Mobile-first layout; responsive; high colour contrast
- [ ] Type safety & lint
  - [ ] Types for payload and validation errors
  - [ ] `npx tsc --noEmit` and `npm run lint -w apps/web`

## Dev Notes

### Relevant Architecture References

- PRD Epic 3 Story 3.1. [Source: `docs/prd.md#story-3.1-worker-induction-form-personal-details`]
- Security patterns (CSRF, RLS). [Source: `docs/architecture.md#architectural-and-design-patterns`]
- Forms & validation. [Source: `docs/architecture.md#api-design-and-data-models`]

### Implementation Outline

- Prefer Server Components; use a Client component for form interactions.
- Store step payload in a secure cookie (httpOnly, signed). Consider `maxAge` and SameSite=Lax.
- Validate on client and server; never trust client input. Normalise phone numbers.
- Keep personal details until final submission (Story 3.2) persists records.
- Follow Australian English spelling and WCAG 2.2.

### Example Snippets

```tsx
// apps/web/src/app/induction/step-1/page.tsx
import PersonalDetailsForm from './PersonalDetailsForm'
import Progress from '../Progress'

export const metadata = { title: 'Induction — Step 1: Personal Details' }

export default function Step1Page() {
  return (
    <main className="mx-auto max-w-xl px-4 sm:px-6 lg:px-8 space-y-8">
      <Progress current={1} total={2} />
      <section>
        <h1 className="text-2xl font-semibold">Step 1: Personal Details</h1>
        <p className="mt-2 text-gray-700">Provide your details to begin induction.</p>
        <PersonalDetailsForm />
      </section>
    </main>
  )
}
```

```tsx
// apps/web/src/app/induction/step-1/PersonalDetailsForm.tsx
'use client'
import { useEffect, useRef, useState } from 'react'
import { saveStep1 } from './actions'

export default function PersonalDetailsForm() {
  const [values, setValues] = useState({ fullName: '', email: '', company: '', trade: '', phone: '' })
  const [csrfToken, setCsrfToken] = useState('')
  const [errors, setErrors] = useState<Record<string, string>>({})
  const [success, setSuccess] = useState('')
  const errorRef = useRef<HTMLDivElement | null>(null)

  useEffect(() => {
    const token = document.cookie.split('; ').find((c) => c.startsWith('csrf_token='))?.split('=')[1] || ''
    setCsrfToken(token)
  }, [])

  useEffect(() => { if (Object.keys(errors).length && errorRef.current) errorRef.current.focus() }, [errors])

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault()
    setErrors({})
    setSuccess('')
    const res = await saveStep1({ ...values, csrfToken, website: '' })
    if (res?.errors) return setErrors(res.errors)
    if (res?.success) setSuccess('Saved. Redirecting…')
  }

  return (
    <form onSubmit={onSubmit} className="mt-6 space-y-4">
      <div aria-live="polite" className="sr-only">{success}</div>
      {Object.keys(errors).length > 0 && (
        <div ref={errorRef} tabIndex={-1} className="rounded border border-red-300 bg-red-50 p-3 text-red-700">Please correct the highlighted fields below.</div>
      )}
      <label className="block">
        <span className="sr-only">Full Name</span>
        <input aria-label="Full Name" value={values.fullName} onChange={(e) => setValues({ ...values, fullName: e.target.value })} placeholder="Full Name" required className="w-full border p-2" />
      </label>
      <label className="block">
        <span className="sr-only">Email</span>
        <input aria-label="Email" type="email" value={values.email} onChange={(e) => setValues({ ...values, email: e.target.value })} placeholder="Email" required className="w-full border p-2" />
      </label>
      <label className="block">
        <span className="sr-only">Company</span>
        <input aria-label="Company" value={values.company} onChange={(e) => setValues({ ...values, company: e.target.value })} placeholder="Company (optional)" className="w-full border p-2" />
      </label>
      <label className="block">
        <span className="sr-only">Trade</span>
        <input aria-label="Trade" value={values.trade} onChange={(e) => setValues({ ...values, trade: e.target.value })} placeholder="Trade" required className="w-full border p-2" />
      </label>
      <label className="block">
        <span className="sr-only">Contact Number</span>
        <input aria-label="Contact Number" inputMode="tel" value={values.phone} onChange={(e) => setValues({ ...values, phone: e.target.value })} placeholder="Contact Number" required className="w-full border p-2" />
      </label>
      {/* Honeypot */}
      <input type="text" name="website" tabIndex={-1} autoComplete="off" className="hidden" aria-hidden="true" />
      <input type="hidden" name="csrfToken" value={csrfToken} />
      <button type="submit" className="bg-black px-4 py-2 text-white">Continue</button>
    </form>
  )
}
```

```ts
// apps/web/src/app/induction/step-1/actions.ts
'use server'
import { cookies } from 'next/headers'
import crypto from 'node:crypto'
import { redirect } from 'next/navigation'

export async function issueCsrfToken() {
  const token = crypto.randomBytes(16).toString('hex')
  cookies().set({ name: 'csrf_token', value: token, httpOnly: true, sameSite: 'lax', secure: true, path: '/' })
  return token
}

function normalisePhone(p: string) {
  return p.replace(/\s+/g, '')
}

export async function saveStep1(input: { fullName: string; email: string; company?: string; trade: string; phone: string; csrfToken: string; website?: string }) {
  const cookieToken = cookies().get('csrf_token')?.value
  if (!cookieToken || cookieToken !== input.csrfToken) return { errors: { form: 'Invalid session' } }
  if (input.website && input.website.trim().length > 0) return { errors: { form: 'Spam detected' } }

  const values = {
    fullName: input.fullName.trim(),
    email: input.email.trim(),
    company: (input.company || '').trim(),
    trade: input.trade.trim(),
    phone: normalisePhone(input.phone)
  }

  const errors: Record<string, string> = {}
  if (!values.fullName) errors.fullName = 'Full Name is required'
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(values.email)) errors.email = 'Enter a valid email'
  if (!values.trade) errors.trade = 'Trade is required'
  if (!/^\+?\d{8,15}$/.test(values.phone)) errors.phone = 'Enter a valid phone number'
  if (Object.keys(errors).length) return { errors }

  const payload = JSON.stringify(values)
  cookies().set({ name: 'induction_session', value: payload, httpOnly: true, sameSite: 'lax', secure: true, path: '/', maxAge: 60 * 60 })

  redirect('/induction/step-2')
}
```

## Testing Requirements

- Client validation prevents submission with invalid email/phone or missing required fields
- Server validation returns field errors; cookie session set on success
- CSRF mismatch and honeypot block submission
- Mobile-first responsiveness; focus management moves to error summary
- TypeScript strict passes and ESLint passes

## Technical Constraints

- Server Components by default; Client only for the form
- No PII exposed beyond session cookie; persist to DB only at final step (3.2)
- Secure cookies; no secrets in client code; environment handled via Next.js

## Assumptions

- Step 2 (Story 3.2) will persist data and handle uploads
- Netlify + Supabase environment is configured; RLS remains enforced

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-15 | 0.1 | Initial draft for Epic 3 Story 3.1 with tasks, server actions, CSRF, accessibility, and tests. | SM |
| 2025-08-17 | 0.2 | Status updated to Ready for Dev after standards review (App Router, TS strict, Tailwind, accessibility, SEO, loading/error). | SM |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
