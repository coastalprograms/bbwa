# Story 6.2: Builder Notifications for On‑site Compliance

## Status

Ready for Dev

## Story

**As a builder**, I want to receive real‑time notifications via email and SMS so that I am immediately alerted when a worker with an expired white card attempts to check in.

## Acceptance Criteria

1. An automation workflow (Make.com or n8n) is configured to receive webhook notifications from the check‑in logic.
2. The webhook is triggered only when a worker is blocked from checking in due to an expired card.
3. The workflow sends an email to the builder including: worker name, reason for denial, timestamp, and site (if available).
4. The workflow sends an SMS to the builder for immediate alerts with the same summary.
5. Observability is in place: webhook deliveries and automation responses are logged, and failures are retried.
6. Duplicate notifications for the same worker/site attempt are rate‑limited (e.g., one per hour).

## Tasks / Subtasks

- [ ] Webhook trigger (AC: 1–2, 5–6)
  - [ ] In `apps/web/src/app/check-in/actions.ts`, on expired card denial, POST to `AUTOMATION_WEBHOOK_URL` with HMAC signature header
  - [ ] Payload: `{ workerId, workerName, workerEmail, siteId, siteName, reason: 'Expired white card', occurredAt }`
  - [ ] Rate‑limit guard (check `compliance_alerts` or a dedicated dedup table before POST)
  - [ ] Log request/response status codes and IDs
- [ ] Automation workflow (AC: 1, 3–4)
  - [ ] Make.com/n8n flow: parse payload, send email and SMS using configured providers
  - [ ] Email template: concise summary with direct links to Admin Workers page
  - [ ] SMS template: short summary with site name; avoid PII beyond name and reason
- [ ] Security (AC: 1)
  - [ ] Use `AUTOMATION_WEBHOOK_URL` and `AUTOMATION_WEBHOOK_SECRET`; compute `X-Signature: sha256` HMAC of body
  - [ ] Automation verifies signature before processing
- [ ] Data & audit (AC: 5–6)
  - [ ] Insert audit row for each attempted send; record duplicates skipped and errors
- [ ] Type safety & lint
  - [ ] Types for webhook payload and audit rows
  - [ ] TS strict and ESLint pass

## Dev Notes

### Relevant Architecture References

- PRD Epic 6 Story 6.2. [Source: `docs/prd/epic-6-automation-notifications.md#story-6.2-builder-notifications-for-on-site-compliance`]
- Security & RLS; check‑in denial flow from Story 4.3. [Source: `docs/stories/4.3.story.md`]

### Implementation Outline

- Extend denial path from `checkIn()` to call `queueNonComplianceAlert()` which:
  - Deduplicates (worker/site within 1h)
  - Enqueues POST to automation with HMAC signature and retries/backoff
  - Inserts audit row with success/failure, provider IDs if available
- In automation, send two messages (email + SMS). If SMS fails but email succeeds, still mark partial success; attempt retry for SMS.

### Example Snippet

```ts
// apps/web/src/lib/alerts.ts (server utility sketch)
import crypto from 'node:crypto'

export async function queueNonComplianceAlert(payload: any) {
  const url = process.env.AUTOMATION_WEBHOOK_URL
  const secret = process.env.AUTOMATION_WEBHOOK_SECRET
  if (!url || !secret) return { skipped: true, reason: 'Webhook not configured' }
  const body = JSON.stringify(payload)
  const sig = crypto.createHmac('sha256', secret).update(body).digest('hex')
  const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Signature': sig }, body })
  return { ok: res.ok, status: res.status }
}
```

## Testing Requirements

- Expired card attempt triggers webhook once per worker/site per hour
- Automation flow receives payload; email and SMS delivered (or mocked) with correct fields
- HMAC signature validated; tampered requests rejected
- Audit rows recorded for success and failure; retries occur on transient failures
- TypeScript and ESLint pass

## Technical Constraints

- Server‑side only for webhooks; no secrets in client
- Use environment variables for automation endpoints and secrets
- Australian English spelling in content; timestamps include timezone

## Assumptions

- Automation platform is reachable; provider credentials for email and SMS are configured there
- Admin Workers page exists to link from email

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-15 | 0.1 | Initial draft for Epic 6 Story 6.2 with webhook trigger, HMAC, and automation flow. | SM |
| 2025-08-17 | 0.2 | Status updated to Ready for Dev after standards review (App Router, TS strict, Tailwind, accessibility, SEO, loading/error). | SM |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
