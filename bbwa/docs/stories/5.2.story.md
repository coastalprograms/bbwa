# Story 5.2: Project Management Interface

## Status

Ready for Dev

## Story

**As a builder**, I want to easily add, edit, and delete projects so that I can keep the public‑facing projects page up‑to‑date.

## Acceptance Criteria

1. Admin page at `/admin/projects` lists projects with actions: Add, Edit, Delete.
2. Add form captures: name (required), description (rich text/plain), category tags, and photos grouped by category: Inside, Outside, Kitchen, Bathroom, Other.
3. Edit pre‑fills fields and allows updating text and media; changes reflect on public site immediately (ISR or revalidation flow).
4. Delete removes the project and associated public references; media files orphaned are handled (soft delete or cascade policy defined).
5. All actions require authentication; enforce authorisation (builder role) and RLS.
6. Loading states, error boundaries, accessible forms (labels, help text, focus management), and mobile‑first UI.

## Tasks / Subtasks

- [ ] Routing & scaffolding (AC: 1, 5–6)
  - [ ] List page (Server): `apps/web/src/app/admin/projects/page.tsx`
  - [ ] Add page (Server + Client form): `apps/web/src/app/admin/projects/new/page.tsx`
  - [ ] Edit page (Server + Client form): `apps/web/src/app/admin/projects/[id]/page.tsx`
  - [ ] Loading/Error UIs in each route
  - [ ] Route metadata
  - [ ] Server guard: redirect unauthenticated/not‑builder to login
- [ ] Data model & storage (AC: 2–4, 5)
  - [ ] Tables: `projects`, `project_photos` (category enum: inside|outside|kitchen|bathroom|other)
  - [ ] Supabase Storage bucket `project-photos` with public read; write restricted to builder
  - [ ] RLS: builder can insert/update/delete; public read for published projects
  - [ ] Optional soft delete: `deleted_at` in `projects`; cascade via policies
- [ ] Forms & server actions (AC: 2–4)
  - [ ] Shared client form component: `ProjectForm.tsx` (Client) for New/Edit
  - [ ] Server actions: `createProject`, `updateProject`, `deleteProject`, `uploadPhotos`
  - [ ] Validate inputs; safe filenames; MIME/size checks; associate photo rows with categories
  - [ ] On success: redirect to list and show toast/alert
- [ ] Public site revalidation (AC: 3)
  - [ ] Trigger on create/update/delete to revalidate projects listing and detail routes
- [ ] Type safety & lint
  - [ ] Types in `apps/web/src/types/projects.ts`
  - [ ] `npx tsc --noEmit`; `npm run lint -w apps/web`

## Dev Notes

### Relevant Architecture References

- PRD Epic 5 Story 5.2. [Source: `docs/prd/epic-5-admin-dashboard-content-management.md#story-5.2-project-management-interface`]
- Security & RLS; Server Components; Storage. [Source: `docs/architecture.md`]
- Data models. [Source: `docs/architecture/data-models.md`]

### Implementation Outline

- List page: server queries `projects` with basic fields and counts of photos; table layout with actions.
- New/Edit use a Client form for file inputs; text inputs handled client‑side; submission via server actions.
- Storage: upload files to `project-photos/{project_id}/{category}/<timestamp>-<slug>.<ext>`; generate public URLs or signed URLs per policy.
- Categories: enforce enum; UI presents tabs or grouped file inputs per category.
- Delete: either hard delete with cascading delete on `project_photos` or soft delete + filter in public queries.
- Accessibility: label all fields; show per‑field errors; error summary `role=alert` and focus on submit failure.

### Example Snippets

```tsx
// apps/web/src/app/admin/projects/page.tsx (list)
import Link from 'next/link'
import { createClient } from '@/src/lib/supabase/server'

export const metadata = { title: 'Projects — Admin' }

export default async function AdminProjectsPage() {
  const supabase = createClient()
  const { data: projects } = await supabase
    .from('projects')
    .select('id, name, updated_at')
    .is('deleted_at', null)
    .order('updated_at', { ascending: false })

  return (
    <main className="mx-auto max-w-4xl px-4 py-6 space-y-4">
      <header className="flex items-center justify-between">
        <h1 className="text-2xl font-semibold">Projects</h1>
        <Link className="rounded bg-black px-3 py-2 text-white" href="/admin/projects/new">Add Project</Link>
      </header>
      <ul className="divide-y">
        {(projects || []).map((p) => (
          <li key={p.id} className="py-3 flex items-center justify-between">
            <div>
              <p className="font-medium">{p.name}</p>
              <p className="text-sm text-gray-600">Updated {new Date(p.updated_at).toLocaleString()}</p>
            </div>
            <div className="flex gap-2">
              <Link className="rounded border px-3 py-1" href={`/admin/projects/${p.id}`}>Edit</Link>
            </div>
          </li>
        ))}
      </ul>
    </main>
  )
}
```

```tsx
// apps/web/src/app/admin/projects/ProjectForm.tsx (client sketch)
'use client'
import { useRef, useState } from 'react'
import { createProject, updateProject } from './actions'

export function ProjectForm({ initial }: { initial?: any }) {
  const [errors, setErrors] = useState<Record<string, string>>({})
  const [status, setStatus] = useState<'idle'|'submitting'>('idle')
  const errorRef = useRef<HTMLDivElement | null>(null)

  async function onSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault()
    setErrors({}); setStatus('submitting')
    const form = new FormData(e.currentTarget)
    const fn = initial ? updateProject : createProject
    const res = await fn(form)
    setStatus('idle')
    if (res?.errors) return setErrors(res.errors)
  }

  return (
    <form onSubmit={onSubmit} className="space-y-4">
      {Object.keys(errors).length > 0 && (
        <div ref={errorRef} tabIndex={-1} role="alert" className="rounded border border-red-300 bg-red-50 p-3 text-red-700">Please correct the highlighted fields below.</div>
      )}
      <label className="block">
        <span className="sr-only">Project Name</span>
        <input name="name" placeholder="Project Name" defaultValue={initial?.name || ''} required className="w-full border p-2" />
      </label>
      <label className="block">
        <span className="sr-only">Description</span>
        <textarea name="description" placeholder="Description" defaultValue={initial?.description || ''} className="w-full border p-2" rows={6} />
      </label>
      <fieldset className="space-y-2">
        <legend className="font-medium">Photos</legend>
        <label className="block">Inside<input name="inside" type="file" accept="image/*" multiple className="mt-1 block w-full" /></label>
        <label className="block">Outside<input name="outside" type="file" accept="image/*" multiple className="mt-1 block w-full" /></label>
        <label className="block">Kitchen<input name="kitchen" type="file" accept="image/*" multiple className="mt-1 block w-full" /></label>
        <label className="block">Bathroom<input name="bathroom" type="file" accept="image/*" multiple className="mt-1 block w-full" /></label>
        <label className="block">Other<input name="other" type="file" accept="image/*" multiple className="mt-1 block w-full" /></label>
      </fieldset>
      <div className="flex gap-2">
        <button disabled={status==='submitting'} className="bg-black px-4 py-2 text-white" type="submit">{initial ? 'Save changes' : 'Create project'}</button>
      </div>
    </form>
  )
}
```

```ts
// apps/web/src/app/admin/projects/actions.ts (sketch)
'use server'
import { createClient } from '@/src/lib/supabase/server'
import { revalidatePath } from 'next/cache'

export async function createProject(form: FormData) {
  const supabase = createClient()
  const name = String(form.get('name') || '').trim()
  if (!name) return { errors: { name: 'Name is required' } }
  const description = String(form.get('description') || '')
  const { data: project, error } = await supabase.from('projects').insert({ name, description }).select('*').single()
  if (error) return { errors: { form: 'Unable to create project at this time.' } }
  await uploadPhotos(supabase, project.id, form)
  revalidatePath('/projects')
  revalidatePath('/admin/projects')
  return { success: true }
}

async function uploadPhotos(supabase: any, id: string, form: FormData) {
  const cats = ['inside','outside','kitchen','bathroom','other'] as const
  for (const cat of cats) {
    const files = form.getAll(cat) as unknown as File[]
    for (let i=0; i<files.length; i++) {
      const f = files[i]
      if (!f || !f.type.startsWith('image/')) continue
      const path = `projects/${id}/${cat}/${Date.now()}-${i}`
      const { error } = await supabase.storage.from('project-photos').upload(path, f, { contentType: f.type })
      if (!error) await supabase.from('project_photos').insert({ project_id: id, path, category: cat })
    }
  }
}
```

## Testing Requirements

- Add project: row inserted; photos uploaded and rows created; lists update; revalidation occurs
- Edit project: updates persisted; photos add/remove handled; lists update
- Delete project: public pages reflect deletion; photos policy respected
- Auth guard enforced; RLS policies verified for admin vs public
- TypeScript strict and ESLint pass; accessibility checks (axe) pass; mobile‑first

## Technical Constraints

- Server Components by default; Client for file inputs
- Supabase with RLS; Storage bucket with proper policies; no secrets client‑side
- Tailwind CSS; Australian English spelling; Netlify deploy

## Assumptions

- Public projects page(s) already exist from Epic 2; ISR or revalidation available
- Builder authentication/authorisation already integrated

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-15 | 0.1 | Initial draft for Epic 5 Story 5.2 with CRUD, Storage uploads, RLS, and revalidation. | SM |
| 2025-08-17 | 0.2 | Status updated to Ready for Dev after standards review (App Router, TS strict, Tailwind, accessibility, SEO, loading/error). | SM |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
