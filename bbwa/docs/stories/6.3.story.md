# Story 6.3: Airtable Integration for Content Management

## Status

Ready for Dev

## Story

**As a builder**, I want to manage dynamic content like FAQs and contact form submissions in Airtable so that I can update them easily without needing to access the admin dashboard or the codebase.

## Acceptance Criteria

1. A Supabase wrapper (Edge Function) allows the application to query FAQ content from Airtable.
2. A Supabase Edge Function receives new `contact_form_submissions` and forwards them to the Airtable base.
3. Public website pages fetch FAQ via the wrapper; failures show a graceful fallback message.
4. Errors are logged; retries/backoff for transient failures; no duplicate submissions are created for the same payload.
5. Secrets are managed via environment variables; no secrets are exposed in client code.

## Tasks / Subtasks

- [ ] Edge Function: `airtable-faq` (AC: 1, 3–5)
  - [ ] Path: `supabase/functions/airtable-faq/index.ts`
  - [ ] Input: none (GET) or query params
  - [ ] Calls Airtable REST API with `AIRTABLE_API_KEY`, `AIRTABLE_BASE_ID`, `AIRTABLE_FAQ_TABLE`
  - [ ] Response: array of `{ question, answer, updated_at }` sorted by a `position` field
  - [ ] Cache control headers (short TTL) and ETag; log failures and return `{ fallback: true }` on error
- [ ] Edge Function: `airtable-contact-forward` (AC: 2, 4–5)
  - [ ] Path: `supabase/functions/airtable-contact-forward/index.ts`
  - [ ] Input: JSON `{ name, email, message, created_at, source }`
  - [ ] Validates inputs; computes idempotency key (hash of contents + timestamp bucket) to avoid duplicates
  - [ ] Inserts a row into Airtable table `AIRTABLE_CONTACT_TABLE`; returns `{ ok: true }` or `{ ok: false }`
  - [ ] Logs errors; retries on 5xx with backoff; never leaks secrets
- [ ] Web app integration (AC: 3)
  - [ ] Update FAQ on public pages to fetch from `airtable-faq` via server component loader with graceful fallback
  - [ ] Update contact form (from Story 2.2) to POST to `airtable-contact-forward` in server action after storing in Supabase
- [ ] Environment (AC: 5)
  - [ ] Env vars: `AIRTABLE_API_KEY`, `AIRTABLE_BASE_ID`, `AIRTABLE_FAQ_TABLE`, `AIRTABLE_CONTACT_TABLE`
- [ ] Type safety & lint
  - [ ] Types for FAQ entries and contact payloads; TS strict; ESLint pass

## Dev Notes

### Relevant Architecture References

- PRD Epic 6 Story 6.3. [Source: `docs/prd/epic-6-automation-notifications.md#story-6.3-airtable-integration-for-content-management`]
- Supabase Edge Functions and security patterns. [Source: `docs/architecture.md`]
- Existing About/Contact implementation references. [Source: `docs/stories/2.2.story.md`]

### Implementation Outline

- Use Airtable REST API (`https://api.airtable.com/v0/{baseId}/{tableName}`) with Bearer token in Edge Functions only.
- For FAQ, map fields to minimal shape and sort by `position` (or `createdTime` if no position field).
- For contact submissions, enforce idempotency using a hash of `name|email|message|bucketedTime` and store the key in Supabase to prevent double‑forwarding.
- Graceful fallback: If `airtable-faq` fails, FAQ component renders a friendly message "FAQ is temporarily unavailable" and logs the incident.
- Ensure AU spelling, accessibility, and mobile‑first presentation for FAQ components.

### Example Snippets

```ts
// supabase/functions/airtable-faq/index.ts (sketch)
import 'jsr:@supabase/functions-js/edge-runtime.d.ts'

Deno.serve(async () => {
  try {
    const apiKey = Deno.env.get('AIRTABLE_API_KEY')
    const baseId = Deno.env.get('AIRTABLE_BASE_ID')
    const table = Deno.env.get('AIRTABLE_FAQ_TABLE')
    if (!apiKey || !baseId || !table) throw new Error('Airtable env not configured')
    const url = `https://api.airtable.com/v0/${baseId}/${encodeURIComponent(table)}?sort[0][field]=position&sort[0][direction]=asc`
    const res = await fetch(url, { headers: { Authorization: `Bearer ${apiKey}` } })
    if (!res.ok) throw new Error('Airtable error: ' + res.status)
    const json = await res.json()
    const items = (json.records || []).map((r: any) => ({ question: r.fields.question, answer: r.fields.answer, updated_at: r.fields.updated_at || r.createdTime }))
    return new Response(JSON.stringify({ items }), { headers: { 'Content-Type': 'application/json', 'Cache-Control': 'public, max-age=120', ETag: crypto.randomUUID() } })
  } catch (e) {
    return new Response(JSON.stringify({ fallback: true, error: String(e) }), { status: 200, headers: { 'Content-Type': 'application/json' } })
  }
})
```

```ts
// supabase/functions/airtable-contact-forward/index.ts (sketch)
import 'jsr:@supabase/functions-js/edge-runtime.d.ts'

Deno.serve(async (req) => {
  try {
    const payload = await req.json()
    if (!payload?.name || !payload?.email || !payload?.message) {
      return new Response(JSON.stringify({ ok: false, error: 'Invalid payload' }), { status: 400 })
    }
    const apiKey = Deno.env.get('AIRTABLE_API_KEY')
    const baseId = Deno.env.get('AIRTABLE_BASE_ID')
    const table = Deno.env.get('AIRTABLE_CONTACT_TABLE')
    if (!apiKey || !baseId || !table) throw new Error('Airtable env not configured')

    const idempotencyKey = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(`${payload.name}|${payload.email}|${payload.message}|${new Date().toISOString().slice(0,13)}`))
    // TODO: check Supabase table to skip duplicates based on idempotencyKey

    const res = await fetch(`https://api.airtable.com/v0/${baseId}/${encodeURIComponent(table)}`, {
      method: 'POST',
      headers: { Authorization: `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ records: [{ fields: payload }] })
    })
    if (!res.ok) throw new Error('Airtable error: ' + res.status)
    return new Response(JSON.stringify({ ok: true }), { headers: { 'Content-Type': 'application/json' } })
  } catch (e) {
    return new Response(JSON.stringify({ ok: false, error: String(e) }), { status: 500, headers: { 'Content-Type': 'application/json' } })
  }
})
```

## Testing Requirements

- FAQ function returns array and renders on public pages; fallback message appears when Airtable fails
- Contact submissions are forwarded once per idempotency window; invalid payloads rejected; errors logged
- No secret leakage; env vars required are validated; TS/ESLint pass

## Technical Constraints

- Supabase Edge Functions only; never call Airtable from the client
- Australian English spelling in content; accessible UI for FAQ
- Respect Airtable API rate limits and pagination if large

## Assumptions

- Airtable base and tables exist with expected field names: `question`, `answer`, `position`
- Contact form server action (Story 2.2) will call this function after local persistence

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-15 | 0.1 | Initial draft for Epic 6 Story 6.3 with FAQ fetch and contact forwarding Edge Functions. | SM |
| 2025-08-17 | 0.2 | Status updated to Ready for Dev after standards review (App Router, TS strict, Tailwind, accessibility, SEO, loading/error). | SM |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
